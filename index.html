// ============================================================
// Excel 1-sloupec → duplicity + chybějící hodnoty
// - čte data z textarea s id="excelInput"
// - výsledek píše do <pre id="result">
// - statistiku píše do <span id="stats">
// - tlačítka: #processBtn a #clearBtn
// ============================================================

function _trim(s) {
  return s.replace(/^[ \t\r\n]+|[ \t\r\n]+$/g, "");
}

/**
 * Pokusí se z řádku vytáhnout číslo.
 * - vezme první buňku (když tam je tabulátor)
 * - toleruje desetinnou čárku (12,0 → 12.0)
 * - vrací celé číslo (Math.trunc)
 */
function parseNumberFromLine(rawLine) {
  const line = _trim(rawLine);
  if (!line) return { ok: false };

  // Pokud by uživatel omylem vložil víc sloupců, vezmeme jen první buňku:
  const firstCell = _trim(line.split("\t")[0]);

  // toleruj desetinnou čárku
  const normalized = firstCell.replace(",", ".");

  const n = Number(normalized);
  if (!Number.isFinite(n)) return { ok: false };

  return { ok: true, value: Math.trunc(n) };
}

/**
 * Načte čísla z jednoho sloupce (po řádcích).
 * Vrací:
 * - values: pole celých čísel
 * - badLines: pole řádků, které nešly převést na číslo
 */
function readSingleColumn(text) {
  const lines = text.replace(/\r/g, "").split("\n");
  const values = [];
  const badLines = [];

  for (const raw of lines) {
    const r = parseNumberFromLine(raw);
    if (!r.ok) {
      if (_trim(raw) !== "") badLines.push(raw);
      continue;
    }
    values.push(r.value);
  }
  return { values, badLines };
}

/**
 * Spočítá duplicity a chybějící hodnoty.
 * missingMode:
 * - "1..max"  (default) – hledá chybějící od 1 do max
 * - "min..max" – hledá chybějící od min do max
 */
function analyze(values, missingMode = "1..max") {
  if (values.length === 0) {
    return {
      min: null,
      max: null,
      counts: new Map(),
      duplicates: [],
      missing: []
    };
  }

  const counts = new Map();
  let min = values[0];
  let max = values[0];

  for (const v of values) {
    counts.set(v, (counts.get(v) || 0) + 1);
    if (v < min) min = v;
    if (v > max) max = v;
  }

  const duplicates = [];
  for (const [val, c] of counts.entries()) {
    if (c >= 2) duplicates.push([val, c]);
  }
  duplicates.sort((a, b) => a[0] - b[0]);

  let start = 1;
  if (missingMode === "min..max") start = min;

  const missing = [];
  for (let i = start; i <= max; i++) {
    if (!counts.has(i)) missing.push(i);
  }

  return { min, max, counts, duplicates, missing };
}

/**
 * Zformátuje seznam chybějících čísel do rozsahů:
 * [1,2,3,7,9,10] → "1-3, 7, 9-10"
 */
function formatAsRanges(nums) {
  if (nums.length === 0) return "";
  const arr = [...nums].sort((a, b) => a - b);

  const parts = [];
  let start = arr[0];
  let prev = arr[0];

  for (let i = 1; i < arr.length; i++) {
    const x = arr[i];
    if (x === prev + 1) {
      prev = x;
      continue;
    }
    // ukonči interval
    parts.push(start === prev ? `${start}` : `${start}-${prev}`);
    start = prev = x;
  }
  parts.push(start === prev ? `${start}` : `${start}-${prev}`);

  return parts.join(", ");
}

// ===================== Napojení na stránku =====================

const excelInput = document.getElementById("excelInput");
const stats = document.getElementById("stats");
const result = document.getElementById("result");

function refreshStats() {
  const { values, badLines } = readSingleColumn(excelInput.value);
  if (values.length === 0) {
    stats.textContent = "";
    return;
  }
  stats.textContent = `Načteno ${values.length} hodnot. Neplatné řádky: ${badLines.length}.`;
}

document.getElementById("processBtn").addEventListener("click", () => {
  const { values, badLines } = readSingleColumn(excelInput.value);

  if (values.length === 0) {
    result.textContent = "Nevložil jsi žádná čísla (zkus Ctrl+V z Excelu).";
    return;
  }

  // Změň na "min..max", pokud chceš chybějící počítat od minima
  const missingMode = "1..max";

  const { min, max, duplicates, missing } = analyze(values, missingMode);

  const out = [];
  out.push(`Načteno hodnot: ${values.length}`);
  out.push(`Rozsah ve vstupu: ${min} .. ${max}`);
  out.push("");

  if (duplicates.length === 0) {
    out.push("Duplicitní hodnoty: žádné ✅");
  } else {
    out.push("Duplicitní hodnoty (hodnota × počet):");
    for (const [v, c] of duplicates) out.push(`- ${v} × ${c}`);
  }

  out.push("");
  const missingLabel = (missingMode === "min..max")
    ? `Chybějící hodnoty (${min}..${max})`
    : `Chybějící hodnoty (1..${max})`;

  if (missing.length === 0) {
    out.push(`${missingLabel}: žádné ✅`);
  } else {
    out.push(`${missingLabel}:`);
    // dvě formy: dlouhý seznam + rozsahy
    out.push(missing.join(" "));
    out.push("");
    out.push("Jako rozsahy:");
    out.push(formatAsRanges(missing));
  }

  if (badLines.length) {
    out.push("");
    out.push(`Ignorované neplatné řádky (${badLines.length}):`);
    for (const s of badLines.slice(0, 10)) out.push(`- ${s}`);
    if (badLines.length > 10) out.push(`- ... +${badLines.length - 10} dalších`);
  }

  result.textContent = out.join("\n");
});

document.getElementById("clearBtn").addEventListener("click", () => {
  excelInput.value = "";
  result.textContent = "Zatím nic.";
  stats.textContent = "";
});

excelInput.addEventListener("input", refreshStats);
excelInput.addEventListener("paste", () => setTimeout(refreshStats, 0));
