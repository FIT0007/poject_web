<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kontrola ƒç√≠sel sv√°r≈Ø podle data</title>

  <style>
    :root{
      --bg: #f6f7fb;
      --text: #0b1220;
      --muted: rgba(11,18,32,.68);
      --card: rgba(255,255,255,.78);
      --card2: rgba(255,255,255,.92);
      --border: rgba(11,18,32,.14);
      --border2: rgba(11,18,32,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --chip: rgba(11,18,32,.06);
      --chipBorder: rgba(11,18,32,.14);
      --accent: #2563eb;
      --good: #16a34a;
      --warn: #d97706;
      --bad: #ef4444;
      --monoBg: rgba(11,18,32,.04);
      --monoBorder: rgba(11,18,32,.12);
    }

    body.dark{
      --bg: #0b1220;
      --text: #e9eefb;
      --muted: rgba(233,238,251,.70);
      --card: rgba(17,27,46,.78);
      --card2: rgba(17,27,46,.92);
      --border: rgba(233,238,251,.14);
      --border2: rgba(233,238,251,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --chip: rgba(233,238,251,.06);
      --chipBorder: rgba(233,238,251,.14);
      --monoBg: rgba(233,238,251,.06);
      --monoBorder: rgba(233,238,251,.14);
    }

    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(37,99,235,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(16,185,129,.14), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .wrap{
      max-width: 1200px;
      margin: 28px auto 60px;
      padding: 0 18px;
    }

    .headerBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 16px;
      margin-bottom: 18px;
    }

    h1{
      margin: 0;
      font-size: 38px;
      letter-spacing: .2px;
    }

    .muted{ color: var(--muted); }
    .small{ font-size: 13px; }

    .card{
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(10px);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1.6fr .9fr;
      gap: 14px;
      margin-top: 14px;
    }

    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
      h1{ font-size: 30px; }
    }

    textarea{
      width: 100%;
      min-height: 230px;
      border-radius: 14px;
      border: 1px solid var(--border2);
      background: rgba(0,0,0,0.02);
      color: var(--text);
      padding: 12px;
      outline: none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      line-height: 1.35;
      resize: vertical;
    }

    body.dark textarea{ background: rgba(255,255,255,0.03); }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }

    button{
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .04s ease, background .2s ease;
    }
    button:hover{ background: rgba(255,255,255,.16); }
    button:active{ transform: translateY(1px); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.10);
    }

    .checkbox{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      font-weight: 650;
    }
    .checkbox input{ transform: translateY(1px); }

    .summaryBox{
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .stat{
      border: 1px solid var(--border2);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.06);
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size: 13px;
    }
    .stat b{
      font-size: 14px;
      letter-spacing: .2px;
    }

    .resultCard{
      margin-top: 14px;
    }

    .resultTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }

    .resultWrap{ display: grid; gap: 10px; }

    details.day{
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--card2);
      overflow:hidden;
    }

    details.day summary{
      cursor: pointer;
      padding: 12px 14px;
      font-weight: 800;
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items:center;
      user-select:none;
    }

    details.day summary:hover{ background: rgba(255,255,255,.06); }

    .sumLeft{ display:flex; align-items:center; gap: 10px; }
    .sumRight{ display:flex; align-items:center; gap: 8px; flex-wrap: wrap; justify-content:flex-end; }

    .tag{
      display:inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--chipBorder);
      background: var(--chip);
      white-space: nowrap;
    }
    .tag.good{ border-color: rgba(22,163,74,.45); background: rgba(22,163,74,.12); color: var(--good); }
    .tag.bad{ border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.12); color: var(--bad); }
    .tag.warn{ border-color: rgba(217,119,6,.45); background: rgba(217,119,6,.12); color: var(--warn); }

    .inside{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--border2);
    }

    .kv{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap: 6px 12px;
      margin: 0 0 12px 0;
      font-size: 13px;
    }
    .kv .k{ color: var(--muted); }

    .blockTitle{ margin: 10px 0 6px; font-weight: 800; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
      background: var(--monoBg);
      border: 1px solid var(--monoBorder);
      border-radius: 12px;
      padding: 10px;
    }

    /* Toggle (dark mode) */
    .themeToggle{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      user-select:none;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.10);
      font-weight: 750;
    }
    .themeToggle input{ display:none; }
    .switch{
      width: 44px; height: 26px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.12);
      position: relative;
      display:inline-block;
      flex: 0 0 auto;
    }
    .knob{
      width: 20px; height: 20px;
      border-radius: 999px;
      background: rgba(255,255,255,.85);
      position:absolute;
      top: 50%;
      left: 3px;
      transform: translateY(-50%);
      transition: left .18s ease;
    }
    body.dark .knob{ left: 21px; }
    body.dark .switch{ background: rgba(37,99,235,.22); border-color: rgba(37,99,235,.35); }

    code{
      padding: 2px 6px;
      border-radius: 8px;
      background: var(--chip);
      border: 1px solid var(--chipBorder);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="headerBar">
      <div>
        <h1>Kontrola ƒç√≠sel sv√°r≈Ø podle data</h1>
        <div class="muted small" style="margin-top:6px;">
          Kontroluje se <b>jen</b>: <b>duplicity</b> a <b>chybƒõj√≠c√≠ ƒç√≠sla v rozsahu min..max</b> pro ka≈æd√Ω den.
        </div>
      </div>

      <!-- Dark mode vpravo naho≈ôe -->
      <label class="themeToggle" id="themeToggle" title="P≈ôepnout svƒõtl√Ω / tmav√Ω re≈æim">
        <input type="checkbox" id="themeCheckbox" />
        <span class="switch" aria-hidden="true"><span class="knob"></span></span>
        <span class="themeLabel" id="themeLabel">üåìDark mode</span>
      </label>
    </div>

    <div class="grid2">
      <div class="card">
        <h3 style="margin:0 0 8px;">Vstupn√≠ data</h3>
        <div class="muted small" style="margin-bottom:10px;">
          oznaƒç v Excelu tabulku <b>vƒçetnƒõ hlaviƒçky</b> (mus√≠ obsahovat <code>DATUM</code> a <code>CISLA SVARU</code>)
          ‚Üí Ctrl+C ‚Üí sem Ctrl+V ‚Üí <b>Pro≈°≈àupej</b>.<br/>
        </div>

        <textarea id="excelInput" placeholder="Sem vlo≈æ tabulku z Excelu..."></textarea>

        <div class="row">
          <button id="processBtn">Pro≈°≈àupej</button>
          <button id="clearBtn">Vymazat</button>

          <div class="muted" id="stats"></div>
        </div>

        <details style="margin-top:10px;">
          <summary class="muted" style="cursor:pointer;">Tip</summary>
          <div style="margin-top:8px; font-size:13px;">
          Mrdej na to a dej si pivson
  </div>
        </details>
      </div>

      <div class="card summaryBox">
        <h3 style="margin:0 0 6px;">Souhrn</h3>

        <div class="stat"><span>≈ò√°dk≈Ø naƒçteno</span> <b id="sumRows">0</b></div>
        <div class="stat"><span>Dn√≠ (unik√°tn√≠ datum)</span> <b id="sumDays">0</b></div>
        <div class="stat"><span>Dny s chybou (dup/chyb√≠)</span> <b id="sumBadDays">0</b></div>
        <div class="stat"><span>OK dny</span> <b id="sumOkDays">0</b></div>

        <div class="muted small">
          Kontroluje:
          <ul style="margin:8px 0 0 18px;">
            <li>duplicity v r√°mci dne</li>
            <li>chybƒõj√≠c√≠ ƒç√≠sla mezi min..max v r√°mci dne</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card resultCard">
      <div class="resultTop">
        <div>
          <h3 style="margin:0;">V√Ωsledek</h3>
          <div class="muted small" id="shownInfo">Moc chlast√°≈°, m√°lo ko√≠ruje≈°.</div>
        </div>

        <div class="pill">
          <label class="checkbox" title="Zobrazit jen dny, kde je duplicita nebo chyb√≠ ƒç√≠slo v min..max">
            <input type="checkbox" id="onlyErrors" />
            üîç filtr: jen dny s chybami
          </label>
        </div>
      </div>

      <div id="result" class="resultWrap">
        <div class="muted">Zat√≠m nic.</div>
      </div>
    </div>
  </div>

  <script>
    // ------------------ Utils ------------------
    function _trim(s){ return String(s ?? "").replace(/^[ \t\r\n]+|[ \t\r\n]+$/g, ""); }

    function _norm(s){
      return _trim(s).toLowerCase()
        .replace(/\s+/g, " ")
        .replace(/[√°√†√§]/g, "a")
        .replace(/[√©ƒõ√®√´]/g, "e")
        .replace(/[√≠√¨√Ø]/g, "i")
        .replace(/[√≥√≤√∂]/g, "o")
        .replace(/[√∫≈Ø√π√º]/g, "u")
        .replace(/[√Ω√ø]/g, "y")
        .replace(/[ƒç]/g, "c")
        .replace(/[≈ô]/g, "r")
        .replace(/[≈°]/g, "s")
        .replace(/[≈æ]/g, "z");
    }

    function _normalizeDashes(s){ return String(s ?? "").replace(/[‚Äì‚Äî‚àí]/g, "-"); }

    function parseDateKey(raw){
      // nech√°me jak je (Excel ƒçasto DD.MM.YYYY)
      return _trim(raw);
    }

    // Jednoduch√Ω CSV/TSV parser pro ≈ô√°dek (podporuje uvozovky)
    function splitRow(line, delimiter){
      const out = [];
      let cur = "";
      let inQ = false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (ch === '"'){
          // "" -> "
          if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
          else inQ = !inQ;
        } else if (!inQ && ch === delimiter){
          out.push(cur);
          cur = "";
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    function detectDelimiter(text){
      // Priorita: tab (Excel copy), pak ; (CZ CSV), pak |, jinak null
      const firstLine = text.replace(/\r/g,"").split("\n").find(l => _trim(l)!=="") || "";
      if (firstLine.includes("\t")) return "\t";
      if (firstLine.includes(";")) return ";";
      if (firstLine.includes("|")) return "|";
      return null;
    }

    // Parse bu≈àky CISLA SVARU:
    // podporuje: 12, 2-11, 1,2, 39,40, 1,2,5-7
    function parseWeldCellToNumbers(cellRaw){
      let s = _trim(cellRaw ?? "");
      s = _normalizeDashes(s);
      if (!s) return { values: [], errors: [] };

      // pryƒç mezery
      s = s.replace(/\s+/g, "");

      const parts = s.split(",");  // ƒç√°rka = seznam polo≈æek/rozsah≈Ø
      const values = [];
      const errors = [];

      for (const partRaw of parts){
        const part = partRaw;
        if (!part) continue;

        const dash = part.indexOf("-");
        if (dash !== -1){
          const left = part.slice(0, dash);
          const right = part.slice(dash + 1);
          if (!left || !right){
            errors.push(`Neplatn√Ω rozsah "${partRaw}"`);
            continue;
          }
          const a0 = Number(left);
          const b0 = Number(right);
          if (!Number.isFinite(a0) || !Number.isFinite(b0)){
            errors.push(`Neplatn√© ƒç√≠slo v rozsahu "${partRaw}"`);
            continue;
          }
          let a = Math.trunc(a0), b = Math.trunc(b0);
          if (a > b) [a,b] = [b,a];
          if (b - a > 2_000_000){
            errors.push(`Rozsah je p≈ô√≠li≈° velk√Ω "${partRaw}"`);
            continue;
          }
          for (let i=a;i<=b;i++) values.push(i);
        } else {
          const n0 = Number(part);
          if (!Number.isFinite(n0)){
            errors.push(`Neplatn√° hodnota "${partRaw}"`);
            continue;
          }
          values.push(Math.trunc(n0));
        }
      }

      return { values, errors };
    }

    function analyzeNumbers(values){
      // ignorujeme <=0 a neint
      const counts = new Map();
      let min = null, max = null;

      for (const v of values){
        if (!Number.isInteger(v) || v <= 0) continue;
        counts.set(v, (counts.get(v) || 0) + 1);
        if (min === null || v < min) min = v;
        if (max === null || v > max) max = v;
      }

      const duplicates = [];
      for (const [val, c] of counts.entries()){
        if (c >= 2) duplicates.push([val, c]);
      }
      duplicates.sort((a,b)=>a[0]-b[0]);

      const missing = [];
      if (min !== null && max !== null){
        for (let i=min;i<=max;i++){
          if (!counts.has(i)) missing.push(i);
        }
      }

      return { min, max, uniqueCount: counts.size, totalCount: values.length, duplicates, missing };
    }

    function formatAsRanges(nums){
      if (!nums.length) return "";
      const arr = [...nums].sort((a,b)=>a-b);
      const parts = [];
      let start = arr[0], prev = arr[0];
      for (let i=1;i<arr.length;i++){
        const x = arr[i];
        if (x === prev + 1){
          prev = x;
        } else {
          parts.push(start === prev ? `${start}` : `${start}-${prev}`);
          start = prev = x;
        }
      }
      parts.push(start === prev ? `${start}` : `${start}-${prev}`);
      return parts.join(", ");
    }

    function dayHasProblem(day){
      return day.duplicates.length > 0 || day.missing.length > 0;
    }

    // ------------------ Table parsing (header tolerant) ------------------
    function parsePastedTable(text){
      const cleaned = text.replace(/\r/g,"");
      const lines = cleaned.split("\n").filter(l => _trim(l) !== "");
      if (lines.length === 0) return { ok:false, error:"Pr√°zdn√Ω vstup." };

      const delim = detectDelimiter(cleaned);
      if (!delim){
        // fallback: zkus tab jako nejƒçastƒõj≈°√≠
        return { ok:false, error:"Nevid√≠m oddƒõlovaƒç sloupc≈Ø. Nejl√©pe vlo≈æ tabulku p≈ô√≠mo z Excelu (tabul√°tory)." };
      }

      const first = splitRow(lines[0], delim);
      const normHeader = first.map(_norm);

      // Je prvn√≠ ≈ô√°dek hlaviƒçka?
      const headerLooksLikeHeader =
        normHeader.some(h => h === "datum") &&
        normHeader.some(h => h.includes("cisla") && h.includes("svar"));

      let dateIdx = -1;
      let weldIdx = -1;
      let startRow = 0;

      if (headerLooksLikeHeader){
        dateIdx = normHeader.findIndex(h => h === "datum" || h.startsWith("datum "));
        weldIdx = normHeader.findIndex(h => h.includes("cisla") && h.includes("svar"));
        startRow = 1;
      } else {
        // fallback bez hlaviƒçky: p≈ôedpoklad 1. sloupec datum
        dateIdx = 0;
        // a ƒç√≠sla sv√°ru zkus 5. sloupec (index 4), jinak posledn√≠
        weldIdx = (first.length >= 5) ? 4 : Math.max(0, first.length - 1);
        startRow = 0;
      }

      const rows = [];
      for (let i=startRow;i<lines.length;i++){
        rows.push(splitRow(lines[i], delim));
      }

      return { ok:true, delimiter: delim, hasHeader: headerLooksLikeHeader, dateIdx, weldIdx, rows };
    }

    // ------------------ DOM refs ------------------
    const excelInput = document.getElementById("excelInput");
    const stats = document.getElementById("stats");
    const resultEl = document.getElementById("result");
    const onlyErrorsEl = document.getElementById("onlyErrors");
    const shownInfo = document.getElementById("shownInfo");

    const sumRows = document.getElementById("sumRows");
    const sumDays = document.getElementById("sumDays");
    const sumBadDays = document.getElementById("sumBadDays");
    const sumOkDays = document.getElementById("sumOkDays");

    let lastDays = []; // cache v√Ωsledk≈Ø pro filtr

    function refreshStats(){
      const parsed = parsePastedTable(excelInput.value);
      if (!parsed.ok){
        stats.textContent = "";
        return;
      }
      const headerMsg = parsed.hasHeader ? "hlaviƒçka: ano" : "hlaviƒçka: ne (fallback)";
      stats.textContent = `Detekov√°no ≈ô√°dk≈Ø: ${parsed.rows.length} ‚Ä¢ ${headerMsg} ‚Ä¢ sloupec datum: #${parsed.dateIdx+1} ‚Ä¢ ƒç√≠sla sv√°ru: #${parsed.weldIdx+1}`;
    }

    function setSummary(rowsCount, daysCount, badDaysCount){
      sumRows.textContent = String(rowsCount);
      sumDays.textContent = String(daysCount);
      sumBadDays.textContent = String(badDaysCount);
      sumOkDays.textContent = String(Math.max(0, daysCount - badDaysCount));
    }

    function renderDays(){
      resultEl.innerHTML = "";

      if (!lastDays.length){
        resultEl.innerHTML = `<div class="muted">Zat√≠m nic.</div>`;
        shownInfo.textContent = "Zat√≠m nic.";
        setSummary(0,0,0);
        return;
      }

      const onlyErr = !!onlyErrorsEl.checked;
      const visible = onlyErr ? lastDays.filter(dayHasProblem) : lastDays;

      const badCount = lastDays.filter(dayHasProblem).length;
      shownInfo.textContent = onlyErr
        ? `Zobrazeno: jen dny s chybami ‚Ä¢ ${visible.length}/${lastDays.length} dn≈Ø`
        : `Zobrazeno: v≈°e ‚Ä¢ ${visible.length} dn≈Ø`;

      // Souhrn (≈ô√°dky si dr≈æ√≠me bokem v lastDaysMeta)
      const rowsCount = lastDays.__rowsCount ?? 0;
      setSummary(rowsCount, lastDays.length, badCount);

      for (const day of visible){
        const details = document.createElement("details");
        details.className = "day";

        const summary = document.createElement("summary");

        const left = document.createElement("div");
        left.className = "sumLeft";
        left.textContent = day.date;

        const right = document.createElement("div");
        right.className = "sumRight";

        const tagStatus = document.createElement("span");
        tagStatus.className = "tag " + (dayHasProblem(day) ? "bad" : "good");
        tagStatus.textContent = dayHasProblem(day) ? "PROBL√âM" : "OK";
        right.appendChild(tagStatus);

        const tagDup = document.createElement("span");
        tagDup.className = "tag";
        tagDup.textContent = `Duplicity: ${day.duplicates.length}`;
        right.appendChild(tagDup);

        const tagMiss = document.createElement("span");
        tagMiss.className = "tag";
        tagMiss.textContent = (day.max === null) ? "Chyb√≠: -" : `Chyb√≠: ${day.missing.length}`;
        right.appendChild(tagMiss);

        summary.appendChild(left);
        summary.appendChild(right);

        const inside = document.createElement("div");
        inside.className = "inside";

        const kv = document.createElement("div");
        kv.className = "kv";
        kv.innerHTML = `
          <div class="k">Rozbalen√Ωch ƒç√≠sel</div><div>${day.totalExpanded}</div>
          <div class="k">Unik√°tn√≠ch ƒç√≠sel</div><div>${day.uniqueCount}</div>
          <div class="k">Rozsah dne (min..max)</div><div>${day.min ?? "-"} .. ${day.max ?? "-"}</div>
        `;
        inside.appendChild(kv);

        const dupTitle = document.createElement("div");
        dupTitle.className = "blockTitle";
        dupTitle.textContent = "Duplicity";
        inside.appendChild(dupTitle);

        const dupBox = document.createElement("div");
        dupBox.className = "mono";
        dupBox.textContent = day.duplicates.length
          ? day.duplicates.map(([v,c]) => `${v} √ó ${c}`).join("\n")
          : "≈Ω√°dn√© ‚úÖ";
        inside.appendChild(dupBox);

        const missTitle = document.createElement("div");
        missTitle.className = "blockTitle";
        missTitle.textContent = "Chybƒõj√≠c√≠ v min..max";
        inside.appendChild(missTitle);

        const missBox = document.createElement("div");
        missBox.className = "mono";
        if (day.max === null){
          missBox.textContent = "≈Ω√°dn√° ƒç√≠sla v tomto dni.";
        } else if (!day.missing.length){
          missBox.textContent = `≈Ω√°dn√© ‚úÖ (v rozsahu ${day.min}..${day.max})`;
        } else {
          missBox.textContent = formatAsRanges(day.missing);
        }
        inside.appendChild(missBox);

        // Voliteln√©: chyby parsov√°n√≠ (jen kdy≈æ je CISLA SVARU neƒçiteln√Ω)
        if (day.parseErrors.length){
          const errTitle = document.createElement("div");
          errTitle.className = "blockTitle";
          errTitle.textContent = "Pozn√°mky (nepoda≈ôilo se p≈ôeƒç√≠st nƒõkter√© hodnoty)";
          inside.appendChild(errTitle);

          const errBox = document.createElement("div");
          errBox.className = "mono";
          errBox.textContent = day.parseErrors.slice(0, 30).join("\n") + (day.parseErrors.length > 30 ? `\n... +${day.parseErrors.length - 30} dal≈°√≠ch` : "");
          inside.appendChild(errBox);
        }

        details.appendChild(summary);
        details.appendChild(inside);
        resultEl.appendChild(details);
      }

      if (!visible.length){
        resultEl.innerHTML = `<div class="muted">Filtr je zapnut√Ω, ale ≈æ√°dn√© dny nemaj√≠ chybu ‚úÖ</div>`;
      }
    }

    function process(){
      const parsed = parsePastedTable(excelInput.value);
      if (!parsed.ok){
        lastDays = [];
        resultEl.innerHTML = `<div class="mono">${parsed.error}</div>`;
        shownInfo.textContent = parsed.error;
        setSummary(0,0,0);
        return;
      }

      const { dateIdx, weldIdx, rows } = parsed;

      // group per day
      const map = new Map(); // date -> { values[], parseErrors[] }
      let seenRows = 0;

      for (let r=0;r<rows.length;r++){
        const cols = rows[r];
        const date = parseDateKey(cols[dateIdx] ?? "");
        const weldCell = cols[weldIdx] ?? "";

        // ignoruj ≈ô√°dky bez data (jen tady nic v√≠c nekontrolujeme)
        if (!date) continue;

        seenRows++;

        const p = parseWeldCellToNumbers(weldCell);
        if (!map.has(date)) map.set(date, { values: [], parseErrors: [] });

        const ref = map.get(date);
        for (const v of p.values) ref.values.push(v);

        if (p.errors.length){
          // ≈ô√°dkov√°n√≠: r + 1 (+ p≈ô√≠padn√° hlaviƒçka u≈æ ne≈ôe≈°√≠me), staƒç√≠ info
          ref.parseErrors.push(`≈ò√°dek ${r + 1}: "${weldCell}" ‚Üí ${p.errors.join("; ")}`);
        }
      }

      // P≈ôevod do listu a se≈ôazen√≠ dle data (pokud to vypad√° jako DD.MM.YYYY)
      const datesSorted = [...map.keys()].sort((a,b)=>{
        const pa = a.split(".").map(x=>parseInt(x,10));
        const pb = b.split(".").map(x=>parseInt(x,10));
        if (pa.length === 3 && pb.length === 3 && pa.every(Number.isFinite) && pb.every(Number.isFinite)){
          const da = new Date(pa[2], pa[1]-1, pa[0]).getTime();
          const db = new Date(pb[2], pb[1]-1, pb[0]).getTime();
          return da - db;
        }
        return a.localeCompare(b, "cs");
      });

      const days = [];
      for (const date of datesSorted){
        const bucket = map.get(date);
        const a = analyzeNumbers(bucket.values);

        days.push({
          date,
          totalExpanded: bucket.values.length,
          uniqueCount: a.uniqueCount,
          min: a.min,
          max: a.max,
          duplicates: a.duplicates,
          missing: a.missing,
          parseErrors: bucket.parseErrors
        });
      }

      // ulo≈æ pro filtr a rendering
      days.__rowsCount = seenRows;
      lastDays = days;

      renderDays();
    }

    // ------------------ Demo data ------------------
    function loadDemo(){
      excelInput.value =
`DATUM\tCISLA SVARU
04.09.2025\t1
04.09.2025\t2-5
04.09.2025\t4
08.09.2025\t1-3
08.09.2025\t5
08.09.2025\t6-8
09.09.2025\t10,12,13-15
09.09.2025\t11
09.09.2025\t14`;
      refreshStats();
      process();
    }

    // ------------------ Dark mode (persist) ------------------
    const themeCheckbox = document.getElementById("themeCheckbox");
    const themeLabel = document.getElementById("themeLabel");

    function applyTheme(isDark){
      document.body.classList.toggle("dark", isDark);
      themeCheckbox.checked = isDark;
      themeLabel.textContent = "Dark mode";
      localStorage.setItem("weld_theme_dark", isDark ? "1" : "0");
    }

    const saved = localStorage.getItem("weld_theme_dark");
    applyTheme(saved === "1");

    document.getElementById("themeToggle").addEventListener("click", (e)=>{
      // klik na label p≈ôepne checkbox, ale my chceme m√≠t jistotu
      const next = !document.body.classList.contains("dark");
      applyTheme(next);
      e.preventDefault();
    });

    // ------------------ Events ------------------
    document.getElementById("processBtn").addEventListener("click", process);
    document.getElementById("demoBtn").addEventListener("click", loadDemo);

    document.getElementById("clearBtn").addEventListener("click", ()=>{
      excelInput.value = "";
      lastDays = [];
      stats.textContent = "";
      renderDays();
    });

    excelInput.addEventListener("input", refreshStats);
    excelInput.addEventListener("paste", ()=> setTimeout(refreshStats, 0));

    onlyErrorsEl.addEventListener("change", renderDays);

    // init empty
    renderDays();
  </script>
</body>
</html>
