<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kontrola čísel svárů</title>

  <style>
    /* =========================
       Theme (CSS variables)
       ========================= */
    :root {
      color-scheme: light dark; /* umožní hezké nativní prvky (scrollbar, inputs) */
      --bg: #ffffff;
      --text: #111;
      --muted: #555;
      --card-bg: rgba(255,255,255,0.92);
      --panel-bg: #ffffff;
      --border: rgba(0,0,0,0.15);
      --border-soft: rgba(0,0,0,0.12);
      --hover: rgba(0,0,0,0.04);
      --mono-bg: rgba(0,0,0,0.03);
      --mono-border: rgba(0,0,0,0.12);
      --btn-bg: #f7f7f7;
      --btn-border: #bbb;
      --btn-hover: #efefef;
      --code-bg: #f3f3f3;
      --shadow: 0 1px 0 rgba(0,0,0,0.03);
    }

    /* Dark overrides */
    [data-theme="dark"] {
      --bg: #0b0f14;
      --text: #e7edf4;
      --muted: #aab6c3;
      --card-bg: rgba(18, 25, 34, 0.92);
      --panel-bg: #0f1620;
      --border: rgba(255,255,255,0.14);
      --border-soft: rgba(255,255,255,0.12);
      --hover: rgba(255,255,255,0.06);
      --mono-bg: rgba(255,255,255,0.06);
      --mono-border: rgba(255,255,255,0.14);
      --btn-bg: rgba(255,255,255,0.06);
      --btn-border: rgba(255,255,255,0.18);
      --btn-hover: rgba(255,255,255,0.10);
      --code-bg: rgba(255,255,255,0.09);
      --shadow: 0 1px 0 rgba(0,0,0,0.35);
    }

    /* =========================
       Base layout
       ========================= */
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 32px;
      max-width: 1200px;
      background: var(--bg);
      color: var(--text);
    }
    h1 { margin-bottom: 8px; }
    .muted { color: var(--muted); }
    .small { font-size: 13px; }

    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      background: var(--panel-bg);
      box-shadow: var(--shadow);
    }

    textarea {
      width: 100%;
      min-height: 220px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      line-height: 1.35;
      outline: none;
    }
    textarea:focus {
      box-shadow: 0 0 0 3px rgba(80, 140, 255, 0.18);
    }

    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background: var(--btn-hover); }

    code {
      background: var(--code-bg);
      padding: 2px 6px;
      border-radius: 6px;
    }
    ul { margin-top: 8px; }

    .resultWrap { display: grid; gap: 10px; }

    .day {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card-bg);
      overflow: hidden;
    }

    .day summary {
      cursor: pointer;
      padding: 12px 14px;
      font-weight: 700;
      user-select: none;
      list-style: none;
    }
    /* remove default marker spacing (still keeps arrow) */
    .day summary::-webkit-details-marker { display: none; }
    .day summary::before {
      content: "▸";
      display: inline-block;
      width: 18px;
      margin-right: 6px;
      transform: translateY(-1px);
      color: var(--muted);
    }
    .day[open] summary::before { content: "▾"; }

    .day summary:hover { background: var(--hover); }

    .day .inside {
      padding: 12px 14px;
      border-top: 1px solid var(--border-soft);
    }

    .kv {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 6px 12px;
      margin: 0 0 10px 0;
      font-size: 13px;
    }
    .kv div { padding: 2px 0; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--border);
      background: var(--mono-bg);
      margin-left: 8px;
      color: var(--text);
    }

    .blockTitle { margin: 10px 0 6px; font-weight: 700; }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
      background: var(--mono-bg);
      border: 1px solid var(--mono-border);
      border-radius: 10px;
      padding: 10px;
    }

    /* --- top toolbar (filter + theme) --- */
    .toolbar {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .filters {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill {
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 8px 10px;
      background: var(--mono-bg);
      font-size: 13px;
    }
    .pill input { transform: translateY(1px); }

    .hint { font-size: 13px; color: var(--muted); }

    .rightTools {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .themeToggle {
      display:inline-flex;
      align-items:center;
      gap:10px;
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 8px 12px;
      background: var(--mono-bg);
      cursor:pointer;
      user-select:none;
      font-size: 13px;
    }
    .themeToggle input { display:none; }

    .switch {
      width: 42px;
      height: 24px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--btn-bg);
      position: relative;
      flex: 0 0 auto;
    }
    .knob {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--text);
      position: absolute;
      top: 50%;
      left: 3px;
      transform: translateY(-50%);
      transition: left .18s ease;
      opacity: 0.9;
    }
    [data-theme="dark"] .knob { left: 21px; }

    .themeLabel {
      color: var(--text);
      font-weight: 600;
    }
  </style>
</head>

<body>
  <h1>Kontrola čísel svárů podle data</h1>

  <div class="card">
    <h3>Tu jebneš celou tabulku (ctrl+c, ctrl+v)</h3>

    <textarea id="excelInput" placeholder="Sem vlož tabulku z Excelu (Ctrl+V)..."></textarea>

    <div class="row" style="margin-top:12px;">
      <button id="processBtn">Zpracovat</button>
      <button id="clearBtn">Vymazat</button>
      <span id="stats" class="muted"></span>
    </div>

    <details style="margin-top:12px;">
      <summary class="muted" style="cursor:pointer;">Tipy (když to nic nenajde)</summary>
      <ul class="muted small">
        <li>Musí být vložená tabulka <b>včetně prvního řádku s hlavičkami</b>.</li>
        <li>Sloupce musí obsahovat něco jako <b>DATUM</b> a <b>ČÍSLA SVAR…</b> (diakritika nevadí).</li>
        <li>Pokud některé řádky nemají datum, vezme se <b>poslední datum nad nimi</b></li>
      </ul>
    </details>
  </div>

  <div class="card">
    <div class="toolbar">
      <div>
        <h3 style="margin:0;">Výsledek</h3>
        <div id="topInfo" class="hint">nešňupej a pracuj ty dobytku.</div>
      </div>

      <div class="rightTools">
        <div class="filters">
          <label class="pill" title="Zobrazí všechny dny">
            <input type="radio" name="filterMode" value="all" checked>
            Zobrazit vše
          </label>

          <label class="pill" title="Zobrazí jen dny, kde jsou duplicity nebo chybí čísla">
            <input type="radio" name="filterMode" value="errorsOnly">
            Jen dny s chybami
          </label>
        </div>

        <!-- Theme toggle -->
        <label class="themeToggle" id="themeToggle" title="Přepnout světlý / tmavý režim">
          <input type="checkbox" id="themeCheckbox" />
          <span class="switch" aria-hidden="true"><span class="knob"></span></span>
          <span class="themeLabel" id="themeLabel">Dark mode</span>
        </label>
      </div>
    </div>

    <div id="result" class="resultWrap">
      <div class="muted">Zatím nic.</div>
    </div>
  </div>

  <script>
    /* =========================
       Theme logic (localStorage + system)
       ========================= */
    const THEME_KEY = "weld_theme"; // "light" | "dark"
    const themeCheckbox = document.getElementById("themeCheckbox");
    const themeLabel = document.getElementById("themeLabel");

    function getSystemPrefersDark() {
      return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    }

    function getSavedTheme() {
      const v = localStorage.getItem(THEME_KEY);
      return (v === "dark" || v === "light") ? v : null;
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      themeCheckbox.checked = (theme === "dark");
      themeLabel.textContent = theme === "dark" ? "Dark mode" : "Light mode";
    }

    function initTheme() {
      const saved = getSavedTheme();
      if (saved) applyTheme(saved);
      else applyTheme(getSystemPrefersDark() ? "dark" : "light");
    }

    initTheme();

    // If user hasn't chosen anything yet, follow system changes:
    const mql = window.matchMedia ? window.matchMedia("(prefers-color-scheme: dark)") : null;
    if (mql) {
      mql.addEventListener("change", () => {
        if (!getSavedTheme()) applyTheme(getSystemPrefersDark() ? "dark" : "light");
      });
    }

    document.getElementById("themeToggle").addEventListener("click", (e) => {
      // zabrání double togglu při kliknutí na label
      e.preventDefault();
      const current = document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "light";
      const next = current === "dark" ? "light" : "dark";
      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
    });

    /* =========================
       App logic
       ========================= */
    function _trim(s) {
      return String(s ?? "").replace(/^[ \t\r\n]+|[ \t\r\n]+$/g, "");
    }

    function _norm(s) {
      return _trim(s).toLowerCase()
        .replace(/\s+/g, " ")
        .replace(/[áàä]/g, "a")
        .replace(/[éěèë]/g, "e")
        .replace(/[íìï]/g, "i")
        .replace(/[óòö]/g, "o")
        .replace(/[úůùü]/g, "u")
        .replace(/[ýÿ]/g, "y")
        .replace(/[č]/g, "c")
        .replace(/[ř]/g, "r")
        .replace(/[š]/g, "s")
        .replace(/[ž]/g, "z");
    }

    function _normalizeDashes(s) {
      return s.replace(/[–—−]/g, "-");
    }

    function parseDateKey(raw) {
      return _trim(raw);
    }

    // supports: "12", "2-11", "1,2", "39,40", "12-18", "1,2,5-7"
    function parseWeldCellToNumbers(cellRaw) {
      let s = _trim(cellRaw ?? "");
      s = _normalizeDashes(s);
      if (!s) return { ok: true, values: [], errors: [] };

      s = s.replace(/\s+/g, "");
      const parts = s.split(",");
      const values = [];
      const errors = [];

      for (const partRaw of parts) {
        const part = partRaw;
        if (!part) continue;

        const dash = part.indexOf("-");
        if (dash !== -1) {
          const left = part.slice(0, dash);
          const right = part.slice(dash + 1);
          if (!left || !right) { errors.push(`Neplatný rozsah "${partRaw}"`); continue; }

          const a0 = Number(left);
          const b0 = Number(right);
          if (!Number.isFinite(a0) || !Number.isFinite(b0)) { errors.push(`Neplatné číslo v rozsahu "${partRaw}"`); continue; }

          let a = Math.trunc(a0), b = Math.trunc(b0);
          if (a > b) [a, b] = [b, a];
          if (b - a > 2_000_000) { errors.push(`Rozsah je příliš velký "${partRaw}"`); continue; }

          for (let i = a; i <= b; i++) values.push(i);
        } else {
          const n0 = Number(part);
          if (!Number.isFinite(n0)) { errors.push(`Neplatná hodnota "${partRaw}"`); continue; }
          values.push(Math.trunc(n0));
        }
      }

      return { ok: errors.length === 0, values, errors };
    }

    function analyzeNumbers(values, mode = "1..max") {
      const counts = new Map();
      let min = null, max = null;

      for (const v of values) {
        if (!Number.isInteger(v) || v <= 0) continue;
        counts.set(v, (counts.get(v) || 0) + 1);
        if (min === null || v < min) min = v;
        if (max === null || v > max) max = v;
      }

      const duplicates = [];
      for (const [val, c] of counts.entries()) {
        if (c >= 2) duplicates.push([val, c]);
      }
      duplicates.sort((a, b) => a[0] - b[0]);

      const missing = [];
      if (max !== null) {
        const start = (mode === "min..max") ? min : 1;
        for (let i = start; i <= max; i++) {
          if (!counts.has(i)) missing.push(i);
        }
      }

      return { min, max, uniqueCount: counts.size, duplicates, missing };
    }

    function formatAsRanges(nums) {
      if (!nums.length) return "";
      const arr = [...nums].sort((a, b) => a - b);
      const parts = [];
      let start = arr[0], prev = arr[0];
      for (let i = 1; i < arr.length; i++) {
        const x = arr[i];
        if (x === prev + 1) prev = x;
        else {
          parts.push(start === prev ? `${start}` : `${start}-${prev}`);
          start = prev = x;
        }
      }
      parts.push(start === prev ? `${start}` : `${start}-${prev}`);
      return parts.join(", ");
    }

    function parsePastedTable(text) {
      const lines = text.replace(/\r/g, "").split("\n").filter(l => _trim(l) !== "");
      if (lines.length === 0) return { ok: false, error: "Prázdný vstup." };

      const header = lines[0].split("\t");
      const normHeader = header.map(_norm);

      const dateIdx = normHeader.findIndex(h => h === "datum" || h.startsWith("datum "));
      if (dateIdx === -1) return { ok: false, error: "Nenašel jsem sloupec 'DATUM' v první řádce." };

      // tolerantní hledání pro "ČÍSLA SVARŮ / CISLA SVARU / ..."
      const weldIdx = normHeader.findIndex(h => h.includes("cisla") && h.includes("svar"));
      if (weldIdx === -1) return { ok: false, error: "Nenašel jsem sloupec 'ČÍSLA SVAR…' v první řádce." };

      const rows = [];
      for (let i = 1; i < lines.length; i++) rows.push(lines[i].split("\t"));

      return { ok: true, dateIdx, weldIdx, rows };
    }

    // ------------------ UI refs ------------------
    const excelInput = document.getElementById("excelInput");
    const stats = document.getElementById("stats");
    const result = document.getElementById("result");
    const topInfo = document.getElementById("topInfo");

    // ------------------ state (for filter) ------------------
    let lastRender = null; // { byDate, errors, datesSorted, missingMode, dayStatsByDate }

    function getFilterMode() {
      const el = document.querySelector('input[name="filterMode"]:checked');
      return el ? el.value : "all";
    }

    function refreshStats() {
      const parsed = parsePastedTable(excelInput.value);
      if (!parsed.ok) { stats.textContent = ""; return; }
      stats.textContent = `Detekováno řádků: ${parsed.rows.length}. Sloupec datum: #${parsed.dateIdx + 1}, čísla svaru: #${parsed.weldIdx + 1}.`;
    }

    function renderFromState() {
      if (!lastRender) {
        result.innerHTML = `<div class="muted">Zatím nic.</div>`;
        topInfo.textContent = "Zatím nic.";
        return;
      }

      const { byDate, errors, datesSorted, missingMode, dayStatsByDate } = lastRender;
      const mode = getFilterMode();

      const totalDays = datesSorted.length;
      const badDays = datesSorted.filter(d => dayStatsByDate.get(d).hasIssue).length;

      if (mode === "errorsOnly") topInfo.textContent = `Zobrazeno: jen dny s chybami • ${badDays}/${totalDays} dnů`;
      else topInfo.textContent = `Zobrazeno: vše • ${totalDays} dnů (chybové dny: ${badDays})`;

      result.innerHTML = "";

      const shownDates = (mode === "errorsOnly")
        ? datesSorted.filter(d => dayStatsByDate.get(d).hasIssue)
        : datesSorted;

      if (shownDates.length === 0) {
        result.innerHTML = `<div class="mono">Podle filtru tu není co zobrazit (žádný den nemá chyby).</div>`;
      } else {
        for (const date of shownDates) {
          const values = byDate.get(date);
          const st = dayStatsByDate.get(date);

          const details = document.createElement("details");
          details.className = "day";

          const summary = document.createElement("summary");
          summary.textContent = date;

          const b1 = document.createElement("span");
          b1.className = "badge";
          b1.textContent = st.duplicates.length ? `Duplicity: ${st.duplicates.length}` : "Duplicity: 0";

          const b2 = document.createElement("span");
          b2.className = "badge";
          b2.textContent = (st.max === null) ? "Chybí: -" : `Chybí: ${st.missing.length}`;

          summary.appendChild(b1);
          summary.appendChild(b2);

          const inside = document.createElement("div");
          inside.className = "inside";

          const kv = document.createElement("div");
          kv.className = "kv";
          kv.innerHTML = `
            <div class="muted">Záznamů po rozbalení</div><div>${values.length}</div>
            <div class="muted">Unikátních čísel</div><div>${st.uniqueCount}</div>
            <div class="muted">Min..Max ve vstupu</div><div>${st.min ?? "-"} .. ${st.max ?? "-"}</div>
          `;
          inside.appendChild(kv);

          const dupTitle = document.createElement("div");
          dupTitle.className = "blockTitle";
          dupTitle.textContent = "Duplicity";
          inside.appendChild(dupTitle);

          const dupBox = document.createElement("div");
          dupBox.className = "mono";
          dupBox.textContent = st.duplicates.length ? st.duplicates.map(([v, c]) => `${v} × ${c}`).join("\n") : "Žádné ✅";
          inside.appendChild(dupBox);

          const missTitle = document.createElement("div");
          missTitle.className = "blockTitle";
          missTitle.textContent = "Chybějící";
          inside.appendChild(missTitle);

          const missBox = document.createElement("div");
          missBox.className = "mono";
          if (st.max === null) missBox.textContent = "Žádná čísla";
          else if (!st.missing.length) missBox.textContent = `Žádné ✅ (v rozsahu 1..${st.max})`;
          else missBox.textContent = formatAsRanges(st.missing);
          inside.appendChild(missBox);

          details.appendChild(summary);
          details.appendChild(inside);
          result.appendChild(details);
        }
      }

      if (errors.length) {
        const warn = document.createElement("details");
        warn.className = "day";

        const sum = document.createElement("summary");
        sum.textContent = `Varování / chyby (${errors.length})`;

        const inside = document.createElement("div");
        inside.className = "inside";

        const box = document.createElement("div");
        box.className = "mono";
        box.textContent =
          errors.slice(0, 30).join("\n") +
          (errors.length > 30 ? `\n... +${errors.length - 30} dalších` : "");

        inside.appendChild(box);
        warn.appendChild(sum);
        warn.appendChild(inside);
        result.appendChild(warn);
      }
    }

    document.getElementById("processBtn").addEventListener("click", () => {
      const parsed = parsePastedTable(excelInput.value);
      if (!parsed.ok) {
        lastRender = null;
        result.innerHTML = `<div class="mono">${parsed.error}</div>`;
        topInfo.textContent = parsed.error;
        return;
      }

      const { dateIdx, weldIdx, rows } = parsed;

      const byDate = new Map();
      const errors = [];

      // řádky bez data ber jako "stejné datum jako řádek nad tím"
      let lastDate = "";

      for (let r = 0; r < rows.length; r++) {
        const cols = rows[r];

        const rawDate = parseDateKey(cols[dateIdx] ?? "");
        const date = rawDate || lastDate;

        if (!date) continue;
        if (rawDate) lastDate = rawDate;

        const weldCell = cols[weldIdx] ?? "";

        const p = parseWeldCellToNumbers(weldCell);
        if (p.errors.length) errors.push(`Řádek ${r + 2} (${date}): ${p.errors.join("; ")} | hodnota: "${weldCell}"`);

        if (!byDate.has(date)) byDate.set(date, []);
        const arr = byDate.get(date);
        for (const v of p.values) arr.push(v);
      }

      if (byDate.size === 0) {
        lastRender = null;
        result.innerHTML = `<div class="mono">Nenašel jsem žádná data (zkontroluj, že jsi vložil tabulku včetně hlavičky).</div>`;
        topInfo.textContent = "Nenašel jsem žádná data.";
        return;
      }

      const missingMode = "1..max";

      const datesSorted = [...byDate.keys()].sort((a, b) => {
        const pa = a.split(".").map(x => parseInt(x, 10));
        const pb = b.split(".").map(x => parseInt(x, 10));
        if (pa.length !== 3 || pb.length !== 3) return a.localeCompare(b);
        return new Date(pa[2], pa[1]-1, pa[0]) - new Date(pb[2], pb[1]-1, pb[0]);
      });

      const dayStatsByDate = new Map();
      for (const date of datesSorted) {
        const values = byDate.get(date);
        const st = analyzeNumbers(values, missingMode);
        const hasIssue =
          (st.duplicates && st.duplicates.length > 0) ||
          (st.max !== null && st.missing && st.missing.length > 0);
        dayStatsByDate.set(date, { ...st, hasIssue });
      }

      lastRender = { byDate, errors, datesSorted, missingMode, dayStatsByDate };
      renderFromState();
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      excelInput.value = "";
      stats.textContent = "";
      lastRender = null;
      result.innerHTML = `<div class="muted">Zatím nic.</div>`;
      topInfo.textContent = "Zatím nic.";
    });

    document.querySelectorAll('input[name="filterMode"]').forEach(el => {
      el.addEventListener("change", () => renderFromState());
    });

    excelInput.addEventListener("input", refreshStats);
    excelInput.addEventListener("paste", () => setTimeout(refreshStats, 0));
  </script>
</body>
</html>
