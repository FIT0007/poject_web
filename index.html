function _trim(s) {
  return s.replace(/^[ \t\r\n]+|[ \t\r\n]+$/g, "");
}

function _norm(s) {
  // normalizace pro porovnání názvů sloupců
  return _trim(s).toLowerCase()
    .replace(/\s+/g, " ")
    .replace(/[áàä]/g, "a")
    .replace(/[éěèë]/g, "e")
    .replace(/[íìï]/g, "i")
    .replace(/[óòö]/g, "o")
    .replace(/[úůùü]/g, "u")
    .replace(/[ýÿ]/g, "y")
    .replace(/[č]/g, "c")
    .replace(/[ř]/g, "r")
    .replace(/[š]/g, "s")
    .replace(/[ž]/g, "z");
}

function _normalizeDashes(s) {
  return s.replace(/[–—−]/g, "-");
}

function parseDateKey(raw) {
  // očekáváme formát jako 04.09.2025 (z Excelu jako text)
  // necháme to jako string klíč, jen trim
  return _trim(raw);
}

// Parse "CISLA SVARU" cell:
// supports: "12", "2-11", "1,2", "39,40", "12-18", "1,2,5-7"
function parseWeldCellToNumbers(cellRaw) {
  let s = _trim(cellRaw ?? "");
  s = _normalizeDashes(s);
  if (!s) return { ok: true, values: [] };

  // odstraníme mezery
  s = s.replace(/\s+/g, "");

  // Rozdělíme podle čárky (seznam položek / rozsahů)
  const parts = s.split(",");
  const values = [];
  const errors = [];

  for (const partRaw of parts) {
    const part = partRaw;
    if (!part) continue;

    const dash = part.indexOf("-");
    if (dash !== -1) {
      const left = part.slice(0, dash);
      const right = part.slice(dash + 1);
      if (!left || !right) {
        errors.push(`Neplatný rozsah "${partRaw}"`);
        continue;
      }
      const a0 = Number(left);
      const b0 = Number(right);
      if (!Number.isFinite(a0) || !Number.isFinite(b0)) {
        errors.push(`Neplatné číslo v rozsahu "${partRaw}"`);
        continue;
      }
      let a = Math.trunc(a0), b = Math.trunc(b0);
      if (a > b) [a, b] = [b, a];
      if (b - a > 2_000_000) {
        errors.push(`Rozsah je příliš velký "${partRaw}"`);
        continue;
      }
      for (let i = a; i <= b; i++) values.push(i);
    } else {
      const n0 = Number(part);
      if (!Number.isFinite(n0)) {
        errors.push(`Neplatná hodnota "${partRaw}"`);
        continue;
      }
      values.push(Math.trunc(n0));
    }
  }

  return { ok: errors.length === 0, values, errors };
}

function analyzeNumbers(values, mode = "1..max") {
  const counts = new Map();
  let min = null, max = null;

  for (const v of values) {
    if (!Number.isInteger(v) || v <= 0) continue;
    counts.set(v, (counts.get(v) || 0) + 1);
    if (min === null || v < min) min = v;
    if (max === null || v > max) max = v;
  }

  const duplicates = [];
  for (const [val, c] of counts.entries()) {
    if (c >= 2) duplicates.push([val, c]);
  }
  duplicates.sort((a, b) => a[0] - b[0]);

  const missing = [];
  if (max !== null) {
    const start = (mode === "min..max") ? min : 1;
    for (let i = start; i <= max; i++) {
      if (!counts.has(i)) missing.push(i);
    }
  }

  return { min, max, uniqueCount: counts.size, duplicates, missing };
}

function formatAsRanges(nums) {
  if (!nums.length) return "";
  const arr = [...nums].sort((a, b) => a - b);
  const parts = [];
  let start = arr[0], prev = arr[0];
  for (let i = 1; i < arr.length; i++) {
    const x = arr[i];
    if (x === prev + 1) {
      prev = x;
    } else {
      parts.push(start === prev ? `${start}` : `${start}-${prev}`);
      start = prev = x;
    }
  }
  parts.push(start === prev ? `${start}` : `${start}-${prev}`);
  return parts.join(", ");
}

function parsePastedTable(text) {
  const lines = text.replace(/\r/g, "").split("\n").filter(l => _trim(l) !== "");
  if (lines.length === 0) return { ok: false, error: "Prázdný vstup." };

  const header = lines[0].split("\t");
  const normHeader = header.map(_norm);

  // Najdi indexy sloupců
  const dateIdx = normHeader.findIndex(h => h === "datum" || h.startsWith("datum "));
  const weldIdx = normHeader.findIndex(h =>
    h.includes("cisla svaru") || h.includes("cila svaru") || h.includes("cisla svar") || h.includes("cisla svaru?")
  );

  if (dateIdx === -1) return { ok: false, error: "Nenašel jsem sloupec 'DATUM' v první řádce." };
  if (weldIdx === -1) return { ok: false, error: "Nenašel jsem sloupec 'CISLA SVARU' v první řádce." };

  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split("\t");
    rows.push(cols);
  }

  return { ok: true, header, dateIdx, weldIdx, rows };
}

// ------------------ Napojení na stránku ------------------
const excelInput = document.getElementById("excelInput");
const stats = document.getElementById("stats");
const result = document.getElementById("result");

function refreshStats() {
  const parsed = parsePastedTable(excelInput.value);
  if (!parsed.ok) {
    stats.textContent = "";
    return;
  }
  stats.textContent = `Detekováno řádků: ${parsed.rows.length}. Sloupec datum: #${parsed.dateIdx+1}, čísla svaru: #${parsed.weldIdx+1}.`;
}

document.getElementById("processBtn").addEventListener("click", () => {
  const parsed = parsePastedTable(excelInput.value);
  if (!parsed.ok) {
    result.textContent = parsed.error;
    return;
  }

  const { dateIdx, weldIdx, rows } = parsed;

  // group: date -> list of numbers (with duplicates)
  const byDate = new Map();
  const errors = [];

  for (let r = 0; r < rows.length; r++) {
    const cols = rows[r];

    const date = parseDateKey(cols[dateIdx] ?? "");
    const weldCell = cols[weldIdx] ?? "";

    if (!date) continue; // ignoruj řádky bez data

    const p = parseWeldCellToNumbers(weldCell);
    if (p.errors && p.errors.length) {
      // řádek v Excelu = r+2 (protože hlavička je 1)
      errors.push(`Řádek ${r + 2} (${date}): ${p.errors.join("; ")} | hodnota: "${weldCell}"`);
    }

    if (!byDate.has(date)) byDate.set(date, []);
    const arr = byDate.get(date);
    for (const v of p.values) arr.push(v);
  }

  if (byDate.size === 0) {
    result.textContent = "Nenašel jsem žádná data (zkontroluj, že jsi vložil tabulku včetně hlavičky).";
    return;
  }

  // Nastavení: chybějící počítat 1..max (doporučuju)
  const missingMode = "1..max";

  // seřaď data chronologicky (DD.MM.YYYY)
  const datesSorted = [...byDate.keys()].sort((a, b) => {
    const pa = a.split(".").map(x => parseInt(x, 10));
    const pb = b.split(".").map(x => parseInt(x, 10));
    if (pa.length !== 3 || pb.length !== 3) return a.localeCompare(b);
    // YYYY,MM,DD
    const da = new Date(pa[2], pa[1]-1, pa[0]).getTime();
    const db = new Date(pb[2], pb[1]-1, pb[0]).getTime();
    return da - db;
  });

  const out = [];
  out.push(`Zpracováno dat: ${byDate.size}`);
  out.push(`Režim chybějících: ${missingMode}`);
  out.push("");

  for (const date of datesSorted) {
    const values = byDate.get(date);

    const { min, max, uniqueCount, duplicates, missing } = analyzeNumbers(values, missingMode);

    out.push(`=== ${date} ===`);
    out.push(`Záznamů po rozbalení: ${values.length}`);
    out.push(`Unikátních čísel: ${uniqueCount}`);
    out.push(`Min..Max ve vstupu: ${min ?? "-"} .. ${max ?? "-"}`);

    if (!duplicates.length) {
      out.push(`Duplicity: žádné ✅`);
    } else {
      out.push(`Duplicity (hodnota × počet):`);
      for (const [v, c] of duplicates) out.push(`- ${v} × ${c}`);
    }

    if (max === null) {
      out.push(`Chybějící: (žádná čísla)`);
    } else if (!missing.length) {
      out.push(`Chybějící (${missingMode === "min..max" ? `${min}..${max}` : `1..${max}`}): žádné ✅`);
    } else {
      out.push(`Chybějící (${missingMode === "min..max" ? `${min}..${max}` : `1..${max}`}):`);
      out.push(formatAsRanges(missing));
    }

    out.push(""); // mezera mezi datumy
  }

  if (errors.length) {
    out.push("=== VAROVÁNÍ / CHYBY ===");
    out.push(`Počet problémů: ${errors.length}`);
    for (const e of errors.slice(0, 15)) out.push(`- ${e}`);
    if (errors.length > 15) out.push(`- ... +${errors.length - 15} dalších`);
  }

  result.textContent = out.join("\n");
});

document.getElementById("clearBtn").addEventListener("click", () => {
  excelInput.value = "";
  stats.textContent = "";
  result.textContent = "Zatím nic.";
});

excelInput.addEventListener("input", refreshStats);
excelInput.addEventListener("paste", () => setTimeout(refreshStats, 0));
